{% extends "core/base.html" %}
{% load crispy_forms_tags %}

{% block title %}Modifier mon Profil - Benin Match{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-20 max-w-6xl">
    <div class="flex flex-col md:flex-row gap-8">
        
        <!-- COLONNE GAUCHE : Identité & Avatar -->
        <div class="md:w-2/3">
            <div class="bg-base-200/50 backdrop-blur-3xl border border-white/10 p-8 rounded-3xl shadow-2xl">
                <div class="flex items-center gap-3 mb-6 pb-6 border-b border-white/10">
                    <div class="p-2 bg-primary/10 rounded-full text-primary">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" /></svg>
                    </div>
                    <h2 class="text-2xl font-black text-base-content">Informations de base</h2>
                </div>

                <form method="post" enctype="multipart/form-data">
                    {% csrf_token %}
                    
                    <!-- SECTION : AVATAR -->
                    <div class="mb-6 bg-base-100/30 p-4 rounded-xl border border-white/5">
                        <label class="label block mb-2">
                            <span class="label-text font-bold text-base-content">Ma photo de profil</span>
                        </label>
                        <div class="flex items-center gap-4">
                            <!-- Avatar Actuel -->
                            <div class="avatar">
                                <div class="w-16 rounded-xl ring ring-offset-base-100 ring-offset-2 ring-primary overflow-hidden bg-black/20">
                                    {% if user.avatar %}
                                        <img src="{{ user.avatar.url }}" class="w-full h-full object-cover">
                                    {% else %}
                                        <img src="https://ui-avatars.com/api/?name={{ user.email }}&background=f97316&color=fff" class="w-full h-full object-cover">
                                    {% endif %}
                                </div>
                            </div>
                            
                            <!-- Input File -->
                            <div class="flex-1">
                                <input type="file" name="avatar" class="file-input file-input-bordered w-full" accept="image/png, image/jpeg, image/webp" />
                                <div class="text-xs text-base-content/50 mt-1">JPG ou PNG. Max 2MB. C'est la photo qui apparaîtra dans la grille.</div>
                            </div>
                        </div>
                    </div>

                    <!-- SECTION : AUTRES CHAMPS (Crispy) -->
                    {{ form|crispy }}
                    
                    <!-- Boutons -->
                    <div class="mt-8 flex justify-end gap-4">
                        <a href="{% url 'profiles:dashboard' %}" class="btn btn-ghost px-8">Annuler</a>
                        <button type="submit" class="btn btn-primary px-12 shadow-lg shadow-primary/30">
                            Sauvegarder
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- COLONNE DROITE : Visuel (Image) -->
        <div class="md:w-1/3 space-y-6">
            
            <!-- Carte : Photo de Couverture (HTMX) -->
            <div class="bg-gradient-to-br from-secondary/20 to-primary/20 border border-white/10 p-6 rounded-3xl shadow-2xl">
                <h3 class="font-black text-base-content mb-4 text-center">Photo de Bannière</h3>
                
                <!-- IMPORTANT : ID POUR HTMX -->
                <!-- Ce bloc sera mis à jour instantanément sans recharger toute la page -->
                <div id="cover-preview-container">
                    <!-- Si on est en GET (première ouverture) -->
                    {% if current_cover %}
                        <div class="w-full h-32 rounded-xl overflow-hidden mb-4 border border-white/10">
                            <img src="{{ current_cover.image.url }}" class="w-full h-full object-cover">
                        </div>
                    {% else %}
                        <div class="w-full h-32 rounded-xl bg-black/20 mb-4 flex items-center justify-center border border-white/10">
                            <span class="text-xs">Aucune bannière</span>
                        </div>
                    {% endif %}
                </div>
                
                <!-- FORMULAIRE HTMX -->
                <form method="post" enctype="multipart/form-data"
                      hx-post="{% url 'profiles:upload_cover' %}"
                      hx-encoding="multipart/form-data"
                      hx-target="#cover-preview-container" 
                      hx-swap="innerHTML"> <!-- Remplace le contenu de la div ID ci-dessus -->
                    
                    {% csrf_token %}

                    <!-- Formulaire Image -->
                    <div class="form-control">
                        <label class="label pb-2">
                            <span class="label-text font-bold text-base-content">Changer la bannière</span>
                        </label>
                        <input type="file" name="image" class="file-input file-input-bordered w-full" accept="image/*" />
                        <label class="label">
                            <span class="label-text-alt">Le changement est instantané (AJAX).</span>
                        </label>
                    </div>

                    <button type="submit" class="btn btn-secondary w-full mt-4 btn-sm">
                        Mettre à jour
                    </button>
                </form>
            </div>

            <!-- Carte : Info -->
            <div class="bg-base-200/30 border border-white/5 p-6 rounded-2xl">
                <h4 class="font-bold text-base-content mb-3">Conseil</h4>
                <p class="text-sm text-base-content/70 leading-relaxed">
                    Une photo de profil attrayante augmente vos chances de matchs de 75%.
                </p>
            </div>
        </div>
    </div>
</div>
{% endblock %}