# CvDidacticiel_API/urls.py

from django.contrib import admin
from django.urls import path, include
from django.conf import settings
from django.conf.urls.static import static 
from rest_framework_simplejwt.views import TokenRefreshView

# Importations pour DRF Spectacular
from drf_spectacular.views import (
    SpectacularAPIView,
    SpectacularSwaggerView,
    SpectacularRedocView
)

# Importations pour dj-rest-auth/allauth (nous utiliserons le flux standard)
# Remarque: Nous utilisons maintenant des vues personnalis√©es (UserRegisterView, LogoutView) dans apps.users
# Les lignes suivantes sont conserv√©es pour les autres fonctionnalit√©s dj-rest-auth (ex: password reset)
#from dj_rest_auth.registration.views import SocialAccountListView, SocialAccountDisconnectView
#from dj_rest_auth.views import LogoutView # NOTE: Vous utilisez la vue LogoutView locale, celle-ci est redondante ici.

# D√©finition des chemins d'acc√®s de l'API et de l'Admin

urlpatterns = [
    # --- ADMIN DJANGO ---
    path('admin/', admin.site.urls),

    # --- API SCH√âMA & DOC (DRF SPECTACULAR) ---
    path('api/schema/', SpectacularAPIView.as_view(), name='schema'),
    path('api/docs/', SpectacularSwaggerView.as_view(url_name='schema'), name='swagger-ui'), 
    path('api/redoc/', SpectacularRedocView.as_view(url_name='schema'), name='redoc'),
    
    # --- AUTHENTIFICATION CONSOLID√âE ---
    
    # 1. Endpoints standards (Login, Logout, Password Change/Reset)
    # Logique : Utilis√© pour les fonctionnalit√©s dj-rest-auth qui ne sont pas g√©r√©es par apps.users
    path('auth/token/refresh/', TokenRefreshView.as_view(), name='token_refresh'),
    path('api/v1/auth/', include('dj_rest_auth.urls')),
    
    # 2. Endpoints d'Inscription/Enregistrement
    #path('api/v1/auth/registration/', include('dj_rest_auth.registration.urls')),
    
    # 3. Social Login (allauth)
    # Logique : Ce chemin est comment√© car il n'est plus n√©cessaire pour le Google ID Token
    #path('api/v1/auth/', include('allauth.urls')), 
    
    # --- API LOCALE (Vos applications) ---
    # Logique : Toutes vos vues d'authentification personnalis√©es (register, me, logout, google_login) sont ici
    path('api/v1/users/', include('apps.users.urls', namespace='users')),
    #path('api/v1/cvs/', include('apps.cv_app.urls', namespace='cv_app')), 
    #path('api/v1/', include('apps.cv_app.urls', namespace='cv_app')), 
    path('api/v1/cvs/', include('apps.cv_app.urls', namespace='cv_app')),
    path('api/v1/payments/', include('apps.payments.urls', namespace='payments')),
]

# Gestion des fichiers m√©dias et statiques en d√©veloppement, et Debug Toolbar
if settings.DEBUG:
    # 1. Debug Toolbar
    import debug_toolbar
    urlpatterns = [
        path('__debug__/', include(debug_toolbar.urls)),
    ] + urlpatterns
    
    # 2. Fichiers M√©dias
    urlpatterns += static(settings.MEDIA_URL, document_root=settings.MEDIA_ROOT)
# backend/apps/users/urls.py

from . import views
from django.urls import path
from .views import ( 
    UserRegisterView,
    UserDetailView,
    AvatarUploadView,
    LogoutView,
    # ‚ùå Retrait de GoogleLogin qui n'est plus utilis√© 
    google_auth, # üí° Ajout de la nouvelle vue
)

# D√©finit le namespace pour les reverses (ex: reverse('users:user-register'))
app_name = 'users'

urlpatterns = [
    # 1. Enregistrement d'un nouvel utilisateur
    path("register/", UserRegisterView.as_view(), name="user-register"),
    
    # 2. Gestion du Profil de l'utilisateur connect√©
    path("me/", UserDetailView.as_view(), name="user-detail"),
    
    # 3. T√©l√©chargement et mise √† jour de l'avatar
    path("me/avatar/", AvatarUploadView.as_view(), name="avatar-upload"),
    
    # 4. D√©connexion
    path("logout/", LogoutView.as_view(), name="user-logout"),
    
    # 5. Authentification Google (NOUVELLE M√âTHODE ID TOKEN)
    # Le frontend enverra le token √† cet endpoint
    path("google-auth/", views.google_auth, name="google-auth-id-token"),
]
# apps/payments/urls.py - CORRIG√â

from django.urls import path
from .views import (
    CreateTransactionView,
    # üõë Correction de 'CanDownloadView' √† 'CheckDownloadPermissionView'
    CheckDownloadPermissionView, 
    # üõë Correction de 'ConsumeCreditsView' √† 'ConsumeDownloadCreditView'
    ConsumeDownloadCreditView,
    CheckTransactionStatusView,
    fedapay_callback,
    FedaPayWebhookView # Ajoutez FedaPayWebhookView si vous l'utilisez
)

app_name = 'payments'

urlpatterns = [
    # Endpoints API
    path('create-transaction/', CreateTransactionView.as_view(), name='create_transaction'),
    
    #  Mise √† jour du nom de la vue et de l'URL pour la clart√©
    path('can-download/<int:cv_id>/', CheckDownloadPermissionView.as_view(), name='can_download'),
    
    # Mise √† jour du nom de la vue
    path('consume-credit/', ConsumeDownloadCreditView.as_view(), name='consume_credit'),
    
    path('check-status/<int:transaction_id>/', CheckTransactionStatusView.as_view(), name='check_status'),
    
    # Callback FedaPay (Redirection utilisateur)
    path('callback/', fedapay_callback, name='fedapay_callback'),
    
    #  Webhook FedaPay (Appel serveur √† serveur)
    path('webhook/', FedaPayWebhookView.as_view(), name='fedapay_webhook'), 
]
#apps/cv_app/urls
from rest_framework.routers import DefaultRouter
from .views import (
    CVViewSet, 
    ContactViewSet, 
    ExperienceViewSet, 
    EducationViewSet, 
    SkillViewSet, 
    LanguageViewSet, 
    InterestViewSet
)

# D√©finition du namespace pour les reverses
app_name = 'cv_app'

# Initialisation du routeur
router = DefaultRouter()

# CORRECTION: Enregistrez les ViewSets avec des pr√©fixes corrects
# Ne laissez PAS le pr√©fixe vide pour CVViewSet
router.register(r'cvs', CVViewSet, basename='cv')
router.register(r'contacts', ContactViewSet, basename='contact')
router.register(r'experiences', ExperienceViewSet, basename='experience')
router.register(r'educations', EducationViewSet, basename='education')
router.register(r'skills', SkillViewSet, basename='skill')
router.register(r'languages', LanguageViewSet, basename='language')
router.register(r'interests', InterestViewSet, basename='interest')

urlpatterns = router.urls