<!-- ========================================= -->
<!-- 4. apps/messaging/templates/messaging/chat.html -->
<!-- Page principale de chat avec POLLING -->
<!-- ========================================= -->
{% extends "core/base.html" %}
{% load static %}

{% block title %}Chat avec {{ other_user.get_full_name }} - Benin Match{% endblock %}

{% block extra_head %}
<style>
    /* Animation pour les nouveaux messages */
    .message-fade-in {
        animation: fadeInUp 0.3s ease-out;
    }
    
    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    /* Style pour le scroll fluide */
    #message-container {
        scroll-behavior: smooth;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-20">
    
    <!-- Container principal du chat -->
    <div class="flex flex-col md:flex-row gap-6 h-[90vh] bg-base-100 rounded-3xl shadow-2xl border border-white/10 overflow-hidden">
        
        <!-- ============================================ -->
        <!-- SIDEBAR GAUCHE - Profil de l'interlocuteur -->
        <!-- ============================================ -->
        <div class="md:w-1/4 bg-base-200/30 border-r border-white/5 p-6 flex flex-col items-center">
            
            <!-- Avatar -->
            <div class="avatar placeholder mb-4">
                <div class="w-24 rounded-xl border-4 border-white/20 overflow-hidden bg-black/20 shadow-xl">
                    {% if other_user.avatar %}
                        <img src="{{ other_user.avatar.url }}" 
                             class="w-full h-full object-cover"
                             alt="{{ other_user.get_full_name }}">
                    {% else %}
                        <div class="w-full h-full flex items-center justify-center bg-secondary text-white text-2xl font-bold">
                            {{ other_user.first_name.0 }}{{ other_user.last_name.0 }}
                        </div>
                    {% endif %}
                </div>
            </div>
            
            <!-- Nom et localisation -->
            <h3 class="text-xl font-black text-center">{{ other_user.get_full_name }}</h3>
            <p class="text-sm text-base-content/60 mb-6">üìç {{ other_user.city|default:"Cotonou" }}</p>
            
            <!-- Actions -->
            <div class="w-full mt-auto space-y-2">
                <a href="{% url 'profiles:detail' other_user.id %}" 
                   class="btn btn-outline btn-sm w-full border-base-300 rounded-2xl">
                    Voir le profil
                </a>
                <button class="btn btn-error btn-sm w-full border-error/20 rounded-2xl">
                    üö´ Bloquer
                </button>
            </div>
        </div>

        <!-- ============================================ -->
        <!-- ZONE CENTRALE - Messages et envoi -->
        <!-- ============================================ -->
        <div class="md:w-3/4 flex flex-col bg-base-100 relative">
            
            <!-- Header du chat -->
            <div class="h-16 border-b border-white/10 flex items-center justify-between px-6 bg-base-200/10 shrink-0">
                <div class="flex items-center gap-3">
                    <!-- Bouton retour (mobile) -->
                    <a href="{% url 'messaging:list' %}" class="btn btn-ghost btn-circle btn-sm md:hidden">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
                        </svg>
                    </a>
                    <span class="font-bold text-base-content">{{ other_user.get_full_name }}</span>
                </div>
                
                <!-- Indicateur en ligne -->
                <div class="flex gap-2 items-center">
                    <span class="w-3 h-3 bg-green-500 rounded-full animate-pulse"></span>
                    <span class="text-xs text-base-content/50">En ligne</span>
                </div>
            </div>

            <!-- ============================================ -->
            <!-- ZONE DE MESSAGES (Scrollable) -->
            <!-- ============================================ -->
            <div id="message-container" 
                 class="flex-1 overflow-y-auto p-4 md:p-6 space-y-4 scroll-smooth bg-gradient-to-b from-base-100 to-base-200/10">
                
                <!-- Messages charg√©s initialement -->
                {% for message in messages %}
                <div class="chat chat-{% if message.sender == user %}end{% else %}start{% endif %}">
                    
                    <!-- Avatar -->
                    <div class="chat-image avatar placeholder">
                        <div class="w-8 h-8 rounded-full">
                            {% if message.sender.avatar %}
                                <img src="{{ message.sender.avatar.url }}" 
                                     class="w-full h-full rounded-full object-cover"
                                     alt="{{ message.sender.get_full_name }}">
                            {% else %}
                                <div class="w-full h-full rounded-full bg-primary/20 flex items-center justify-center text-xs font-bold text-primary">
                                    {{ message.sender.first_name.0 }}
                                </div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Bulle de message -->
                    <div class="chat-bubble {% if message.sender == user %}chat-bubble-primary{% else %}chat-bubble-secondary{% endif %} rounded-2xl shadow-lg">
                        {% if message.image %}
                            <img src="{{ message.image.url }}" 
                                 class="mb-2 rounded-xl max-w-[200px] cursor-pointer hover:opacity-90 transition"
                                 onclick="window.open(this.src, '_blank')"
                                 alt="Image">
                        {% endif %}
                        {% if message.content %}
                            <p class="text-base-content break-words">{{ message.content }}</p>
                        {% endif %}
                        <time class="text-[10px] opacity-50 block mt-1">
                            {{ message.created_at|date:"H:i" }}
                        </time>
                    </div>

                    <!-- Statut de lecture (pour mes messages) -->
                    {% if message.sender == user %}
                        <div class="chat-footer opacity-50 text-[10px] flex items-center gap-1">
                            {% if message.is_read %}
                                <svg class="w-4 h-4 text-blue-500" fill="currentColor" viewBox="0 0 20 20">
                                    <path d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z"/>
                                </svg>
                                Lu
                            {% else %}
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                                </svg>
                                Envoy√©
                            {% endif %}
                        </div>
                    {% endif %}
                </div>
                {% empty %}
                <div class="flex h-full items-center justify-center">
                    <p class="text-base-content/40 italic">Envoyez le premier message ! üí¨</p>
                </div>
                {% endfor %}
            </div>

            <!-- ============================================ -->
            <!-- ZONE D'ENVOI (Footer) -->
            <!-- ============================================ -->
            <div class="p-4 bg-base-200/10 border-t border-white/10 shrink-0">
                
                <!-- Formulaire avec HTMX -->
                <form method="post" 
                      enctype="multipart/form-data" 
                      hx-post="{% url 'messaging:detail' thread.id %}" 
                      hx-swap="beforeend" 
                      hx-target="#message-container" 
                      hx-indicator="#sending-indicator"
                      class="space-y-2">
                    {% csrf_token %}
                    
                    <!-- Indicateur d'envoi -->
                    <div id="sending-indicator" class="hidden text-center text-primary text-sm animate-pulse">
                        ‚è≥ Envoi en cours...
                    </div>

                    <!-- Champ de saisie -->
                    <div class="flex gap-3 items-end">
                        
                        <!-- Bouton image -->
                        <button type="button" 
                                onclick="document.getElementById('id_image').click()"
                                class="btn btn-ghost btn-circle text-base-content/60 hover:text-primary">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 15.5M15 8h.01M5 20h14a2 2 0 002-2V6a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                            </svg>
                        </button>

                        <!-- Formulaire (cach√© par d√©faut) -->
                        <div class="hidden">
                            {{ form.image }}
                        </div>

                        <!-- Textarea message -->
                        <div class="flex-1">
                            {{ form.content }}
                        </div>

                        <!-- Bouton envoyer -->
                        <button type="submit" class="btn btn-primary btn-circle">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/>
                            </svg>
                        </button>
                    </div>
                </form>
            </div>

        </div>
    </div>
</div>

<!-- ============================================ -->
<!-- JAVASCRIPT - POLLING (Simule le temps r√©el) -->
<!-- ============================================ -->
<script>
    /**
     * SYST√àME DE POLLING POUR MESSAGES EN TEMPS R√âEL
     * 
     * PRINCIPE :
     * 1. Toutes les 3 secondes, on demande au serveur s'il y a de nouveaux messages
     * 2. On envoie l'ID du dernier message qu'on a
     * 3. Le serveur nous renvoie les messages plus r√©cents (s'il y en a)
     * 4. On les ins√®re dans la page avec une animation
     */
    
    // Variable globale : ID du dernier message re√ßu
    let lastMessageId = {{ last_message_id }};
    
    // Conteneur des messages
    const messageContainer = document.getElementById('message-container');
    
    /**
     * Fonction de polling : v√©rifie les nouveaux messages
     */
    function checkNewMessages() {
        // Ne pas interroger si l'onglet n'est pas visible (√©conomie de ressources)
        if (document.hidden) return;
        
        // Requ√™te AJAX vers l'API de polling
        fetch(`{% url 'messaging:poll' thread.id %}?last_id=${lastMessageId}`)
            .then(response => response.text())
            .then(html => {
                // Si on a re√ßu du HTML (= nouveaux messages)
                if (html.trim() !== "") {
                    // Cr√©er un √©l√©ment temporaire pour parser le HTML
                    const tempDiv = document.createElement('div');
                    tempDiv.innerHTML = html;
                    
                    // Ajouter les nouveaux messages au conteneur
                    messageContainer.insertAdjacentHTML('beforeend', html);
                    
                    // Mettre √† jour l'ID du dernier message
                    const allMessages = messageContainer.querySelectorAll('.chat');
                    if (allMessages.length > 0) {
                        // On suppose que le dernier message a l'ID le plus √©lev√©
                        lastMessageId = parseInt(lastMessageId) + tempDiv.querySelectorAll('.chat').length;
                    }
                    
                    // Scroll automatique vers le bas
                    scrollToBottom();
                    
                    // OPTIONNEL : Jouer un son de notification
                    // playNotificationSound();
                    
                    // OPTIONNEL : Afficher une notification navigateur
                    // showBrowserNotification();
                }
            })
            .catch(error => {
                console.error('Erreur polling:', error);
            });
    }
    
    /**
     * Scroll automatique vers le bas (smooth)
     */
    function scrollToBottom() {
        setTimeout(() => {
            messageContainer.scrollTop = messageContainer.scrollHeight;
        }, 100);
    }
    
    /**
     * OPTIONNEL : Jouer un son de notification
     */
    function playNotificationSound() {
        const audio = new Audio('/static/sounds/notification.mp3');
        audio.volume = 0.3;
        audio.play().catch(e => console.log('Son d√©sactiv√©'));
    }
    
    /**
     * OPTIONNEL : Notification navigateur
     */
    function showBrowserNotification() {
        if ("Notification" in window && Notification.permission === "granted") {
            new Notification("Nouveau message", {
                body: "{{ other_user.get_full_name }} vous a envoy√© un message",
                icon: "{% if other_user.avatar %}{{ other_user.avatar.url }}{% endif %}"
            });
        }
    }
    
    // Lancer le polling toutes les 3 secondes (3000 ms)
    setInterval(checkNewMessages, 3000);
    
    // Scroll initial au chargement de la page
    scrollToBottom();
    
    // R√©initialiser le formulaire apr√®s envoi HTMX
    document.body.addEventListener('htmx:afterRequest', function(event) {
        if (event.detail.successful) {
            // R√©initialiser le textarea
            const textarea = document.querySelector('textarea[name="content"]');
            if (textarea) {
                textarea.value = '';
                textarea.style.height = 'auto';
            }
            
            // Scroll vers le bas apr√®s ajout
            scrollToBottom();
        }
    });
    
    // Auto-resize du textarea pendant la frappe
    const textarea = document.querySelector('textarea[name="content"]');
    if (textarea) {
        textarea.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = this.scrollHeight + 'px';
        });
    }
</script>

{% endblock %}