<!-- ========================================= -->
<!-- 4. apps/messaging/templates/messaging/chat.html -->
<!-- Page principale de chat avec POLLING - CORRIG√â et NETTOY√â -->
<!-- ========================================= -->
{% extends "core/base.html" %}
{% load static %}

{% block title %}Chat avec {{ other_user.get_full_name }} - Benin Match{% endblock %}

{% block extra_head %}
<style>
    /* Animation pour les nouveaux messages */
    .message-fade-in {
        animation: fadeInUp 0.3s ease-out;
    }
    
    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    /* Style pour le scroll fluide */
    #message-container {
        scroll-behavior: smooth;
    }
    
    /* Style pour l'aper√ßu de l'image s√©lectionn√©e */
    .image-preview-container {
        display: none;
        margin-bottom: 10px;
        padding: 10px;
        background: rgba(0, 0, 0, 0.05);
        border-radius: 12px;
        align-items: center;
        gap: 10px;
    }
    
    .image-preview {
        width: 80px;
        height: 80px;
        object-fit: cover;
        border-radius: 8px;
        border: 2px solid var(--fallback-p, oklch(var(--p)));
    }
    
    /* Taille r√©duite pour les images dans les messages */
    .message-image {
        max-width: 150px !important;
        max-height: 150px;
        border-radius: 10px;
        cursor: pointer;
        transition: opacity 0.2s;
    }
    
    .message-image:hover {
        opacity: 0.9;
    }
    
    /* Style am√©lior√© pour le textarea */
    .message-textarea {
        min-height: 44px;
        max-height: 120px;
        resize: none;
        border-radius: 25px;
        padding: 12px 20px;
        border: 1px solid #e2e8f0;
        background: #f8fafc;
    }
    
    .message-textarea:focus {
        outline: none;
        border-color: var(--fallback-p, oklch(var(--p)));
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }
</style>
{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-20">
    
    <!-- Container principal du chat -->
    <div class="flex flex-col md:flex-row gap-6 h-[90vh] bg-base-100 rounded-3xl shadow-2xl border border-white/10 overflow-hidden">
        
        <!-- SIDEBAR GAUCHE - Profil de l'interlocuteur -->
        <div class="md:w-1/4 bg-base-200/30 border-r border-white/5 p-6 flex flex-col items-center">
            
            <!-- Avatar -->
            <div class="avatar placeholder mb-4">
                <div class="w-24 rounded-xl border-4 border-white/20 overflow-hidden bg-black/20 shadow-xl">
                    {% if other_user.avatar %}
                        <img src="{{ other_user.avatar.url }}" 
                             class="w-full h-full object-cover"
                             alt="{{ other_user.get_full_name }}">
                    {% else %}
                        <div class="w-full h-full flex items-center justify-center bg-secondary text-white text-2xl font-bold">
                            {{ other_user.first_name.0 }}{{ other_user.last_name.0 }}
                        </div>
                    {% endif %}
                </div>
            </div>
            
            <!-- Nom et localisation -->
            <h3 class="text-xl font-black text-center">{{ other_user.get_full_name }}</h3>
            <p class="text-sm text-base-content/60 mb-6">üìç {{ other_user.city|default:"Cotonou" }}</p>
            
            <!-- Actions -->
            <div class="w-full mt-auto space-y-2">
                <a href="{% url 'profiles:detail' other_user.id %}" 
                   class="btn btn-outline btn-sm w-full border-base-300 rounded-2xl">
                    Voir le profil
                </a>
                <button class="btn btn-error btn-sm w-full border-error/20 rounded-2xl">
                    üö´ Bloquer
                </button>
            </div>
        </div>

        <!-- ZONE CENTRALE - Messages et envoi -->
        <div class="md:w-3/4 flex flex-col bg-base-100 relative">
            
            <!-- Header du chat -->
            <div class="h-16 border-b border-white/10 flex items-center justify-between px-6 bg-base-200/10 shrink-0">
                <div class="flex items-center gap-3">
                    <!-- Bouton retour (mobile) -->
                    <a href="{% url 'messaging:list' %}" class="btn btn-ghost btn-circle btn-sm md:hidden">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
                        </svg>
                    </a>
                    <span class="font-bold text-base-content">{{ other_user.get_full_name }}</span>
                </div>
                
                <!-- Indicateur en ligne -->
                <div class="flex gap-2 items-center">
                    <span class="w-3 h-3 bg-green-500 rounded-full animate-pulse"></span>
                    <span class="text-xs text-base-content/50">En ligne</span>
                </div>
            </div>

            <!-- ZONE DE MESSAGES (Scrollable) -->
            <div id="message-container" 
                 class="flex-1 overflow-y-auto p-4 md:p-6 space-y-4 scroll-smooth bg-gradient-to-b from-base-100 to-base-200/10">
                
                <!-- Messages charg√©s initialement -->
                {% for message in messages %}
                <div class="chat chat-{% if message.sender == user %}end{% else %}start{% endif %} message-fade-in">
                    
                    <!-- Avatar -->
                    <div class="chat-image avatar placeholder">
                        <div class="w-8 h-8 rounded-full">
                            {% if message.sender.avatar %}
                                <img src="{{ message.sender.avatar.url }}" 
                                     class="w-full h-full rounded-full object-cover"
                                     alt="{{ message.sender.get_full_name }}">
                            {% else %}
                                <div class="w-full h-full rounded-full bg-primary/20 flex items-center justify-center text-xs font-bold text-primary">
                                    {{ message.sender.first_name.0 }}
                                </div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Bulle de message -->
                    <div class="chat-bubble {% if message.sender == user %}chat-bubble-primary{% else %}chat-bubble-secondary{% endif %} rounded-2xl shadow-lg">
                        {% if message.image %}
                            <img src="{{ message.image.url }}" 
                                 class="message-image mb-2"
                                 onclick="window.open(this.src, '_blank')"
                                 alt="Image">
                        {% endif %}
                        {% if message.content %}
                            <p class="text-base-content break-words">{{ message.content }}</p>
                        {% endif %}
                        <time class="text-[10px] opacity-50 block mt-1">
                            {{ message.created_at|date:"H:i" }}
                        </time>
                    </div>

                    <!-- Statut de lecture (pour mes messages) -->
                    {% if message.sender == user %}
                        <div class="chat-footer opacity-50 text-[10px] flex items-center gap-1">
                            {% if message.is_read %}
                                <svg class="w-4 h-4 text-blue-500" fill="currentColor" viewBox="0 0 20 20">
                                    <path d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z"/>
                                </svg>
                                Lu
                            {% else %}
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                                </svg>
                                Envoy√©
                            {% endif %}
                        </div>
                    {% endif %}
                </div>
                {% empty %}
                <div class="flex h-full items-center justify-center">
                    <p class="text-base-content/40 italic">Envoyez le premier message ! üí¨</p>
                </div>
                {% endfor %}
            </div>

            <!-- ZONE D'ENVOI (Footer) -->
            <div class="p-4 bg-base-200/10 border-t border-white/10 shrink-0">
                
                <!-- Aper√ßu de l'image -->
                <div id="image-preview-container" class="image-preview-container hidden">
                    <div class="flex items-center gap-3">
                        <img id="image-preview" class="image-preview" src="" alt="Aper√ßu">
                        <div class="flex flex-col">
                            <span class="text-xs text-base-content/60">Photo √† envoyer</span>
                            <button type="button" 
                                    onclick="removeImagePreview()" 
                                    class="btn btn-xs btn-error mt-1">
                                ‚úï Supprimer
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Formulaire avec HTMX -->
                <form id="message-form" 
                      method="post" 
                      enctype="multipart/form-data" 
                      hx-post="{% url 'messaging:detail' thread.id %}" 
                      hx-swap="beforeend"
                      hx-target="#message-container" 
                      hx-indicator="#sending-indicator"
                      hx-encoding="multipart/form-data"
                      class="space-y-2">
                    {% csrf_token %}
                    
                    <!-- Indicateur d'envoi -->
                    <div id="sending-indicator" class="hidden text-center text-primary text-sm animate-pulse">
                        ‚è≥ Envoi en cours...
                    </div>

                    <!-- Champ de saisie -->
                    <div class="flex gap-3 items-end">
                        
                        <!-- Bouton image avec input file -->
                        <div class="relative">
                            <label for="id_image" 
                                   class="btn btn-ghost btn-circle text-base-content/60 hover:text-primary cursor-pointer flex items-center justify-center">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                                          d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 15.5M15 8h.01M5 20h14a2 2 0 002-2V6a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                                </svg>
                            </label>
                            
                            <!-- Champ fichier -->
                            <input type="file" 
                                   id="id_image" 
                                   name="image" 
                                   accept="image/*"
                                   class="absolute top-0 left-0 w-full h-full opacity-0 cursor-pointer"
                                   onchange="previewImage(this)">
                        </div>

                        <!-- Champ texte -->
                        <div class="flex-1">
                            <textarea name="content" 
                                      id="id_content"
                                      class="message-textarea w-full"
                                      placeholder="√âcrivez votre message..."
                                      rows="1"></textarea>
                        </div>

                        <!-- Bouton envoyer -->
                        <button type="submit" 
                                class="btn btn-primary btn-circle">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/>
                            </svg>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- JAVASCRIPT CORRIG√â -->
<script>
    // Variables globales
    let lastMessageId = {{ last_message_id|default:0 }};
    const messageContainer = document.getElementById('message-container');
    const messageForm = document.getElementById('message-form');
    let pollingInterval;
    let isPolling = false;

    /**
     * Affiche un aper√ßu de l'image s√©lectionn√©e
     */
    function previewImage(input) {
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            
            reader.onload = function(e) {
                const previewContainer = document.getElementById('image-preview-container');
                const previewImg = document.getElementById('image-preview');
                
                previewImg.src = e.target.result;
                previewContainer.classList.remove('hidden');
                
                // Scroll doux vers la zone d'envoi
                setTimeout(() => {
                    previewContainer.scrollIntoView({ 
                        behavior: 'smooth', 
                        block: 'nearest' 
                    });
                }, 100);
            }
            
            reader.readAsDataURL(input.files[0]);
        }
    }

    /**
     * Supprime l'aper√ßu de l'image
     */
    function removeImagePreview() {
        const input = document.getElementById('id_image');
        const previewContainer = document.getElementById('image-preview-container');
        const previewImg = document.getElementById('image-preview');
        
        if (input) {
            input.value = '';
        }
        
        if (previewImg) {
            previewImg.src = '';
        }
        
        if (previewContainer) {
            previewContainer.classList.add('hidden');
        }
    }

    /**
     * Validation du formulaire
     */
    function validateForm() {
        const textarea = document.querySelector('textarea[name="content"]');
        const fileInput = document.getElementById('id_image');
        
        const hasText = textarea && textarea.value.trim() !== '';
        const hasImage = fileInput && fileInput.files.length > 0;
        
        if (!hasText && !hasImage) {
            alert('Veuillez √©crire un message ou s√©lectionner une photo');
            return false;
        }
        
        return true;
    }

    /**
     * Scroll automatique vers le bas
     */
    function scrollToBottom() {
        setTimeout(() => {
            if (messageContainer) {
                messageContainer.scrollTop = messageContainer.scrollHeight;
            }
        }, 100);
    }

    /**
     * Polling pour r√©cup√©rer les nouveaux messages
     */
    function checkNewMessages() {
        if (document.hidden || isPolling) return;
        
        isPolling = true;
        
        fetch(`{% url 'messaging:poll' thread.id %}?last_id=${lastMessageId}`)
            .then(response => response.text())
            .then(html => {
                if (html.trim() !== "") {
                    // Ajouter les nouveaux messages
                    messageContainer.insertAdjacentHTML('beforeend', html);
                    
                    // Mettre √† jour l'ID du dernier message
                    const newMessages = document.querySelectorAll('#message-container .chat');
                    if (newMessages.length > 0) {
                        const lastMessage = newMessages[newMessages.length - 1];
                        const messageId = lastMessage.getAttribute('data-message-id');
                        if (messageId) {
                            lastMessageId = parseInt(messageId);
                        }
                    }
                    
                    scrollToBottom();
                }
            })
            .catch(error => {
                console.error('Erreur polling:', error);
            })
            .finally(() => {
                isPolling = false;
            });
    }

    /**
     * R√©initialiser le formulaire apr√®s envoi
     */
    function resetForm() {
        const textarea = document.querySelector('textarea[name="content"]');
        
        if (textarea) {
            textarea.value = '';
            textarea.style.height = 'auto';
        }
        
        removeImagePreview();
        
        const indicator = document.getElementById('sending-indicator');
        if (indicator) {
            indicator.classList.add('hidden');
        }
    }

    /**
     * Auto-resize du textarea
     */
    const textarea = document.querySelector('textarea[name="content"]');
    if (textarea) {
        textarea.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = Math.min(this.scrollHeight, 120) + 'px';
        });
    }

    /**
     * Gestion des √©v√©nements HTMX
     */
    document.body.addEventListener('htmx:afterRequest', function(event) {
        if (event.detail.target === messageContainer && event.detail.successful) {
            resetForm();
            scrollToBottom();
            
            // Mettre √† jour lastMessageId avec le nouveau message
            const newMessages = messageContainer.querySelectorAll('.chat');
            if (newMessages.length > 0) {
                const lastMessage = newMessages[newMessages.length - 1];
                const messageId = lastMessage.getAttribute('data-message-id');
                if (messageId) {
                    lastMessageId = parseInt(messageId);
                }
            }
        }
    });

    document.body.addEventListener('htmx:beforeRequest', function(event) {
        if (event.detail.target === messageContainer) {
            // Validation avant envoi
            if (!validateForm()) {
                event.preventDefault();
                return;
            }
            
            // Afficher l'indicateur
            const indicator = document.getElementById('sending-indicator');
            if (indicator) {
                indicator.classList.remove('hidden');
            }
        }
    });

    /**
     * Initialisation
     */
    document.addEventListener('DOMContentLoaded', function() {
        scrollToBottom();
        
        // D√©marrer le polling
        pollingInterval = setInterval(checkNewMessages, 2000);
        
        // Validation sur soumission du formulaire
        messageForm.addEventListener('submit', function(e) {
            if (!validateForm()) {
                e.preventDefault();
                return false;
            }
            return true;
        });
        
        // Gestion de la visibilit√©
        document.addEventListener('visibilitychange', function() {
            if (document.hidden) {
                clearInterval(pollingInterval);
            } else {
                clearInterval(pollingInterval);
                pollingInterval = setInterval(checkNewMessages, 2000);
                checkNewMessages();
            }
        });
    });

    // Nettoyage
    window.addEventListener('beforeunload', function() {
        clearInterval(pollingInterval);
    });
</script>

{% endblock %}